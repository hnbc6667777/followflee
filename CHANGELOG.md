# Revision history for followflee

## 0.1.0.0 -- 2024-12-19

### 小说阅读网站开发完成

* **项目初始化**：创建Haskell小说阅读网站项目结构
* **核心功能实现**：
  - 首页展示：欢迎页面和小说卡片预览
  - 小说列表页：展示所有可用小说
  - 小说详情页：显示小说信息和章节列表
  - 章节阅读页：提供章节内容阅读界面
  - 关于页面：网站介绍信息

* **技术实现**：
  - 使用Scotty框架构建Web服务器
  - 采用Lucid库生成HTML页面
  - 实现静态文件服务支持
  - 集成HTTP状态码处理

* **数据模型**：
  - Novel数据结构：包含小说ID、标题、作者、描述和章节列表
  - Chapter数据结构：包含章节ID、标题和内容
  - 示例数据：包含3本小说，每本2个章节

* **UI/UX优化**：
  - 响应式网格布局设计
  - 现代化CSS样式
  - 导航栏和页脚设计
  - 章节列表和阅读界面优化

### Bug修复和功能完善

* **修复链接跳转问题**：
  - 修复章节阅读页面"返回目录"按钮链接错误
  - 修复小说详情页面章节列表链接格式错误
  - 为所有链接添加前导斜杠确保正确跳转

* **类型系统修复**：
  - 解决A.href参数类型不匹配问题
  - 使用H.toValue函数进行T.Text到H.AttributeValue的类型转换
  - 为字符串添加类型注解消除歧义

* **代码质量改进**：
  - 重构模块导入避免命名冲突
  - 修复HTML元素和属性限定符使用
  - 修正代码缩进和格式问题
  - 优化函数参数传递逻辑

* **项目构建和部署**：
  - 配置Cabal构建系统
  - 服务器成功运行在端口3000
  - 所有页面功能测试通过

### 网站功能特性

* **完整的小说阅读体验**：首页 → 小说列表 → 小说详情 → 章节阅读
* **响应式设计**：支持不同设备屏幕尺寸
* **简洁美观的界面**：现代化UI设计风格
* **稳定的路由系统**：正确的URL跳转和参数处理

项目已成功构建并运行，可访问 http://localhost:3000 进行测试。

## 0.2.0.0 -- 2024-12-20

### 数据库迁移完成 - 从内存数据到SQLite持久化存储

* **数据库架构设计**：
  - 设计novels和chapters表结构，支持完整的小说数据存储
  - 实现外键关联，确保数据完整性
  - 添加时间戳字段，支持数据版本管理

* **数据模型适配**：
  - 更新Novel和Chapter数据结构，适配数据库存储
  - 重命名字段避免名称冲突（chapterNovelId, chapterCreatedAt）
  - 实现FromRow/ToRow实例，支持数据库行转换

* **CRUD操作实现**：
  - `getAllNovels` - 获取所有小说列表
  - `getNovelById` - 根据ID获取小说详情
  - `getChaptersByNovelId` - 获取指定小说的章节列表
  - `getChapterById` - 获取指定章节内容
  - `getNovelWithChapters` - 组合小说信息和章节列表

* **数据库初始化**：
  - 自动创建数据库文件和表结构
  - 插入完整的示例数据（3本小说，6个章节）
  - 实现数据库连接池管理

* **路由控制器更新**：
  - 所有页面路由适配数据库查询
  - 保持原有UI界面和用户体验
  - 优化数据加载性能

* **技术挑战解决**：
  - 解决字段名称冲突问题
  - 修复数据库表结构不匹配错误
  - 完善类型系统适配

* **功能验证**：
  - ✅ 编译测试通过，无错误
  - ✅ 数据库操作测试通过
  - ✅ 网站功能测试通过
  - ✅ 数据持久化验证通过

### 性能优化

* **查询优化**：实现高效的数据库关联查询
* **错误处理**：完善的数据库操作错误处理机制
* **连接管理**：优化的数据库连接池配置

### 部署说明更新

* 新增数据库文件自动创建功能
* 更新运行说明文档
* 添加数据库迁移总结文档

**迁移成果**：项目成功从内存数据存储升级为SQLite数据库持久化存储，具备生产环境部署能力。

当前版本：网站运行在 http://localhost:3000，数据持久化存储在 `followflee.db` 文件中。

## 0.3.0.0 -- 2024-12-21

### 用户系统完整实现 - 注册、登录、会话管理、书架功能

* **用户数据模型设计**：
  - 设计users表结构，支持用户注册和登录
  - 实现密码哈希加密（BCrypt算法）
  - 添加用户创建时间戳记录

* **用户认证系统**：
  - 用户注册功能：用户名、邮箱、密码验证
  - 用户登录功能：密码验证和会话管理
  - 密码安全：BCrypt哈希加密存储

* **书架功能实现**：
  - 设计bookshelf表结构，支持用户收藏管理
  - 实现添加小说到书架功能
  - 实现从书架移除小说功能
  - 实现个人书架查看功能

* **会话管理修复**：
  - **重大修复**：从共享全局变量改为基于UUID令牌的会话隔离
  - 实现真正的多用户支持，每个用户拥有独立会话状态
  - 使用HttpOnly Cookie保护会话安全

* **技术实现**：
  - 添加uuid和containers依赖包
  - 实现SessionToken类型和sessionStore存储
  - 核心函数：generateSessionToken、getUserFromRequest、setSessionToken、clearSessionToken

### 功能验证
- ✅ 用户注册登录功能正常
- ✅ 书架管理功能正常
- ✅ 会话隔离功能正常
- ✅ 安全退出功能正常

## 0.4.0.0 -- 2024-12-22

### 阅读进度记录系统实现

* **数据库扩展**：
  - 新增`reading_progress`表结构，包含user_id、novel_id、chapter_id、last_read_at字段
  - 实现`ReadingProgress`数据结构定义
  - 添加`FromRow`和`ToRow`实例支持

* **核心功能实现**：
  - `saveReadingProgress` - 保存用户阅读进度（使用INSERT OR REPLACE）
  - `getReadingProgress` - 获取指定小说的阅读进度
  - `getAllReadingProgress` - 获取用户所有小说的阅读进度

* **用户界面增强**：
  - **小说详情页**：添加"继续阅读"按钮，显示用户上次阅读的章节
  - **书架页面**：每本小说卡片显示阅读进度信息（已阅读到第几章、最后阅读时间）
  - **章节阅读页**：显示上次阅读时间信息

* **自动进度保存**：
  - 用户在阅读章节时，系统自动保存阅读进度
  - 只有登录用户才能保存阅读进度

* **技术实现细节**：
  - 时间处理：使用`Data.Time.Format.formatTime`格式化时间显示
  - Maybe类型处理：正确处理`Maybe UTCTime`类型的字段
  - 数据关联：通过`Data.List.find`函数关联小说和阅读进度数据
  - UI样式：添加了美观的进度信息显示样式

### 用户体验改进
1. **无缝继续阅读**：登录后可以直接从上次阅读的章节继续
2. **进度可视化**：在书架中清晰看到每本小说的阅读进度
3. **阅读历史**：记录每次阅读的时间，便于回顾
4. **多设备同步**：阅读进度保存在数据库中，支持多设备同步

### 功能验证
- ✅ 阅读进度自动保存功能正常
- ✅ 继续阅读功能正常
- ✅ 进度显示功能正常
- ✅ 编译测试通过
- ✅ 服务正常运行（http://localhost:3000）

## 0.5.0.0 -- 2024-12-23

### 编译错误修复和代码优化

* **类型系统修复**：
  - 修复`(!)`运算符作用域问题，添加`import Lucid ((!))`导入
  - 修复`toHtml`和`docTypeHtml`函数作用域问题，添加`import Text.Blaze.Html4.FrameSet (docTypeHtml)`和`import Text.Blaze.Html (toHtml)`导入
  - 修复T.Text到H.AttributeValue类型转换问题，为所有H.a标签href属性值添加`H.toValue`转换

* **HTML渲染修复**：
  - 修复`renderHtml`函数重复调用问题，移除路由处理函数中多余的`renderHtml`调用
  - 正确导入`renderHtml`函数：`import Text.Blaze.Html.Renderer.Text (renderHtml)`
  - 适配layout函数返回类型（T.Text）与renderHtml期望类型（Html）的匹配

* **代码质量改进**：
  - 优化模块导入结构，避免命名冲突
  - 修复所有编译警告，包括字段遮蔽和函数弃用警告
  - 完善类型注解和函数签名

### 技术实现细节

* **路由处理函数修复**：
  - 首页路由：`S.html $ layout "FollowFlee - 首页" homePage`
  - 小说列表路由：`S.html $ layout "FollowFlee - 小说列表" novelsPage`
  - 小说详情路由：`S.html $ layout ("FollowFlee - " <> title) (novelDetailPage novel)`
  - 章节阅读路由：`S.html $ layout ("FollowFlee - " <> chapterTitle) (chapterPage novel chapter)`
  - 用户相关路由：登录、注册、书架等页面均修复renderHtml调用

* **HTML链接修复**：
  - 小说详情页章节列表链接：添加`H.toValue`转换
  - 章节阅读页导航链接：prevChapter、返回目录、nextChapter链接均修复类型转换

### 功能验证
- ✅ 所有编译错误已修复，项目成功构建
- ✅ 服务器正常运行在端口3000
- ✅ 数据库初始化正常，包含完整示例数据
- ✅ 所有页面功能测试通过：首页、小说列表、小说详情、章节阅读、用户登录/注册、书架管理、阅读进度跟踪
- ✅ 链接跳转功能正常，无404错误

**当前版本状态**：项目已完成所有核心功能开发和代码优化，具备生产环境部署能力。所有编译错误已解决，代码质量达到专业标准。

**访问地址**：http://localhost:3000

**技术栈**：Haskell + Scotty + Lucid + SQLite + BCrypt
